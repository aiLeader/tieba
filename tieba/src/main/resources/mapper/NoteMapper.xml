<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 映射文件的命名空间namespace的值是，与之对应的映射接口的全类名 -->
<mapper namespace="com.yc.tieba.mapper.NoteMapper">
	<resultMap type="PaginationBean" id="PaginationBeanMap">
		<result column="pageSize" property="pageSize" />
		<result column="currPage" property="currPage" />
		<collection property="rows"
			column="{pageSize=pageSize,currPage=currPage,options=options}"
		 select="getnote" />
	</resultMap>
	
	<select id="findNote" parameterType="Map" resultMap="PaginationBeanMap">
	</select>

  <resultMap type="NoteInfo" id="NoteInfoMap">
	  	<id column="nid" property="nid"/>
	  <result column="ntitle" property="ntitle"/><!--column为取到的值的名字 property为类中的名称  -->
	  <result column="ncontent" property="ncontent"/>
	  <result column="ntimes" property="ntimes"/>
	  <result column="nnum" property="nnum"/>
	  <result column="naccess" property="naccess"/>
	  <result column="ngood" property="ngood"/>
	  <result column="nstatus" property="nstatus"/>
	  <result column="nstates" property="nstates"/>
	  <association property="types" column="tid" javaType="Types">
	  	<id column="tid" property="tid"/>
	  	<id column="tname" property="tname"/>
	  </association>
	  <association property="users" column="userid" javaType="Users">
	  	<id column="userid" property="userid"/>
	  	<id column="uname" property="uname"/>
	  </association>
	  </resultMap>
	  
		<select id="getnote"  resultMap="NoteInfoMap">
		select * from
		(select n.*, rownum rn from
		(select o.*,u.uname uname,t.tname tname from note o,users u,types t  where
		o.nstatus in (0,1)
		<if test="options!=null">
			and (o.nid like '%${options}%'
			or o.ntitle like '%${options}%'
			or o.ncontent like '%${options}%'
			or o.ntimes like '%${options}%'
			)
		</if>
		and o.userid=u.userid and o.tid = t.tid
		) n
		where ${pageSize}* ${currPage} >= rownum)
		where
		rn>(${currPage}-1)*${pageSize}
	</select>
	
	
	<!--    通过tid查找     -->
	<select id="findTyId" parameterType="String" resultType="int">
		select tid from types where
		tstate in (0,1) 
		<if test="_parameter!=null">
			and (tid like '%${_parameter}%'
			or tname like '%${_parameter}%'
			or tnum like '%${_parameter}%'
			or tdesc like '%${_parameter}%'
			)
		</if>
	</select>
	
	<resultMap type="PaginationBean" id="PaginationBeanMap02">
		<result column="pageSize" property="pageSize" />
		<result column="currPage" property="currPage" />
		<collection property="rows"
			column="{pageSize=pageSize,currPage=currPage,options=options}"
		 select="getnote02" />
	</resultMap>
	
	<select id="findNoteTy" parameterType="Map" resultMap="PaginationBeanMap02">
		select count(1) total, ceil(count(1) /${pageSize}) totalPage,
		${pageSize} pageSize,${currPage} currPage
		<if test="options!=null">
			,'${options}' options
		</if>
		<if test="options==null">
			,'' options
		</if>
		from note where nstatus in (0,1) and nstates  in (0,1)
		<if test="options!=null">
			and  note.tid = '${options}'
		</if>
	</select>

		<select id="getnote02"  resultMap="NoteInfoMap">
		select * from
		(select n.*, rownum rn from
		(select o.*,u.uname uname,t.tname tname from note o,users u,types t  where
		o.nstatus in (0,1)
		<if test="options!=null">
			and o.tid = '${options}'
		</if>
		and o.userid=u.userid and o.tid = t.tid
		) n
		where ${pageSize}* ${currPage} >= rownum)
		where
		rn>(${currPage}-1)*${pageSize}
	</select>

	
	<!-- 通过userid查找 -->
	<select id="findUsId" parameterType="String" resultType="int">
	select userid from users where
		status in (0,1) 
		<if test="_parameter !=null">
			and (uname like '%${_parameter}%'
			or userid like '%${_parameter}%'
			or sex like '%${_parameter}%'
			or telephone like '%${_parameter}%'
			or email like '%${_parameter}%'
			)
		</if>
	</select>
	
	<resultMap type="PaginationBean" id="PaginationBeanMap03">
		<result column="pageSize" property="pageSize" />
		<result column="currPage" property="currPage" />
		<collection property="rows"
			column="{pageSize=pageSize,currPage=currPage,options=options}"
		 select="getnote03" />
	</resultMap>
	
	<select id="findNoteUs" parameterType="Map" resultMap="PaginationBeanMap03">
		select count(1) total, ceil(count(1) /${pageSize}) totalPage,
		${pageSize} pageSize,${currPage} currPage
		<if test="options!=null">
			,'${options}' options
		</if>
		<if test="options==null">
			,'' options
		</if>
		from note where nstatus in (0,1) and nstates  in (0,1)
		<if test="options!=null">
			and userid ='${options}'
		</if>
	</select>

	<select id="getnote03"  resultMap="NoteInfoMap">
		select * from
		(select n.*, rownum rn from
		(select o.*,u.uname uname,t.tname tname from note o,users u,types t  where
		o.nstatus in (0,1)
		<if test="options!=null">
			and  o.userid ='${options}'
		</if>
		and o.userid=u.userid and o.tid = t.tid
		) n
		where ${pageSize}* ${currPage} >= rownum)
		where
		rn>(${currPage}-1)*${pageSize}
	</select>
	
	

	<!-- 删除note -->
	<update id="deleteNote" parameterType="String">
		update note set nstatus =0 where  nid = #{ids}
	</update>
	
	<!-- 修改note -->
	<update id="updateNote" parameterType="NoteInfo">
		update note set nstatus =#{nstatus},nstates=#{nstates} where  nid = #{nid}
	</update>
	
	<!-- 根据评论数量显示前五条帖子 -->
	<select id="listNoteOrderByNum" resultType="NoteInfo">
		select n.*,rownum from NOTE n where  5>=rownum order by nnum desc 
	</select>
</mapper>
